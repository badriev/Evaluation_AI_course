# üè† Semantic Price Scraper Agent

AI-–∞–≥–µ–Ω—Ç –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ü–µ–Ω –Ω–∞ –∂–∏–ª—å—ë.  
–ü–æ—Å—Ç—Ä–æ–µ–Ω –Ω–∞ **LangChain** + **OpenAI LLM**, –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å **LangSmith** –∏ **Langfuse** –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ç—Ä–µ–π—Å–∏–Ω–≥–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏.

---

## üìñ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- üîé –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–π —Å —Å–∞–π—Ç–æ–≤ (title, price, currency, url)
- üßπ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –æ–±—ä—è–≤–ª–µ–Ω–∏–π –ø–æ —Ü–µ–Ω–µ –∏ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
- üí± –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ü–µ–Ω –≤ —Ä–∞–∑–Ω—ã–µ –≤–∞–ª—é—Ç—ã (USD, RUB, EUR)
- üìä –ü–æ–¥—Å—á—ë—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ —Ü–µ–Ω–∞–º (min, max, avg, median)
- üíæ –ó–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
- üìà **–ü–æ–ª–Ω—ã–π —Ç—Ä–µ–π—Å–∏–Ω–≥ —Å Langfuse** - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –≤—ã–∑–æ–≤–æ–≤ LLM –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
- üîÑ **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏** - –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- üë• **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ user_id** - –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º

---

## üõ† –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (Tools)

–ê–≥–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç 4 –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞, –∫–∞–∂–¥—ã–π –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö –æ–±—ë—Ä–Ω—É—Ç –≤ Langfuse `@observe` –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ç—Ä–µ–π—Å–∏–Ω–≥–∞:

### 1. `extract_offers`
–ò–∑–≤–ª–µ–∫–∞–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è —Å —É–∫–∞–∑–∞–Ω–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã.  
**–í—Ö–æ–¥:** URL, limit  
**–í—ã—Ö–æ–¥:** –º–∞—Å—Å–∏–≤ –æ–±—ä—è–≤–ª–µ–Ω–∏–π `{title, price, currency, url}`

### 2. `filter_offers`
–§–∏–ª—å—Ç—Ä—É–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è –ø–æ —Ü–µ–Ω–µ –∏ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º.  
**–í—Ö–æ–¥:** —Å–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π, min/max —Ü–µ–Ω–∞, —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∏–ª—å—Ç—Ä  
**–í—ã—Ö–æ–¥:** –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫

### 3. `normalize_offers_currency`
–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç —Ü–µ–Ω—ã –æ–±—ä—è–≤–ª–µ–Ω–∏–π –≤ –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∞–ª—é—Ç—É (RUB / USD / EUR).  
**–í—Ö–æ–¥:** –æ–±—ä—è–≤–ª–µ–Ω–∏—è + —Ü–µ–ª–µ–≤–∞—è –≤–∞–ª—é—Ç–∞  
**–í—ã—Ö–æ–¥:** –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è

### 4. `compute_stats`
–°—Ç—Ä–æ–∏—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —Ü–µ–Ω–∞–º.  
**–í—Ö–æ–¥:** –ª–∏–±–æ —Å–ø–∏—Å–æ–∫ —Ü–µ–Ω, –ª–∏–±–æ —Å–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π  
**–í—ã—Ö–æ–¥:** `{min, max, avg, median}`

–ê–≥–µ–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π –≤ —Å–µ—Å—Å–∏—é –∏ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –µ–≥–æ –≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–µ—Ä–µ–¥–∞—ë—Ç `offers` –≤—Ä—É—á–Ω—É—é.

---

## üîÑ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≥–µ–Ω—Ç (–ø—Ä–æ—Ü–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏)

1. **–ü–æ–ª—É—á–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞**  
   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å —Å –≤–æ–ø—Ä–æ—Å–æ–º –∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) —Å—Å—ã–ª–∫–∞–º–∏.

2. **–°–æ–∑–¥–∞–Ω–∏–µ trace –≤ Langfuse –∏ Langsmith**  
   –í–Ω—É—Ç—Ä–∏ `run_question()` –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ `agent_execution`, –≤ –∫–æ—Ç–æ—Ä–æ–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ø–∞–¥–∞—é—Ç:
   - –≤—ã–∑–æ–≤—ã LLM
   - –≤—ã–∑–æ–≤—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
   - –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —à–∞–≥–∏ –∞–≥–µ–Ω—Ç–∞ (Chain-of-Thought —Å–∫—Ä—ã—Ç)
   - session_id –∏ user_id (–µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω—ã)

3. **–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ –¥–µ–π—Å—Ç–≤–∏–π**  
   LLM –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π prompt –∏ –≤—ã–±–∏—Ä–∞–µ—Ç, –∫–∞–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –≤—ã–∑—ã–≤–∞—Ç—å.

4. **–í—ã–∑–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤**  
   –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–æ–ø—Ä–æ—Å–∞:
   - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
   - —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
   - –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤–∞–ª—é—Ç
   - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
   –í—Å–µ —à–∞–≥–∏ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ `intermediate_steps`.

5. **–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞**  
   –ê–≥–µ–Ω—Ç —Å–æ–±–∏—Ä–∞–µ—Ç –∏—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç + –º–∞—Å—Å–∏–≤ `tools_used` –≤ –ø–æ—Ä—è–¥–∫–µ –≤—ã–∑–æ–≤–∞.

6. **–í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∫–ª–∏–µ–Ω—Ç—É**  
   `/ask` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
   ```json
   {
     "output": "–æ—Ç–≤–µ—Ç –∞–≥–µ–Ω—Ç–∞",
     "tools_used": ["extract_offers", "filter_offers"],
     "_session_id": "...",
     "_user_id": "..."
   }
   ```

–≠—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ–≤–µ–¥–µ–Ω–∏—è –∞–≥–µ–Ω—Ç–∞.

---


## üì° API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

### 1. `/ask` ‚Äî –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –∞–≥–µ–Ω—Ç—É —Å —Ç—Ä–µ–π—Å–∏–Ω–≥–æ–º

**POST**
```json
{
  "question": "–ù–∞–π–¥–∏ –∫–≤–∞—Ä—Ç–∏—Ä—ã –¥–µ—à–µ–≤–ª–µ 2000 –¥–æ–ª–ª–∞—Ä–æ–≤",
  "urls": ["https://example.com"],
  "session_id": "uuid-—Å–µ—Å—Å–∏–∏",  // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
  "user_id": "user123"          // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
}
```

**–° –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º HTTP —Ö–µ–¥–µ—Ä–æ–≤ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):**
```bash
curl -X POST http://localhost:8000/ask \
  -H "Content-Type: application/json" \
  -H "X-Session-Id: 123e4567-e89b-12d3-a456-426614174000" \
  -H "X-User-Id: user123" \
  -d '{
    "question": "–ù–∞–π–¥–∏ –∫–≤–∞—Ä—Ç–∏—Ä—ã –¥–µ—à–µ–≤–ª–µ 2000 –¥–æ–ª–ª–∞—Ä–æ–≤",
    "urls": ["https://www.rentalads.com/apartments-for-rent/ny/new-york/"]
  }'
```

### 2. `/session/new` ‚Äî —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é

**GET**
```bash
curl http://localhost:8000/session/new
```

–û—Ç–≤–µ—Ç:
```json
{
  "session_id": "123e4567-e89b-12d3-a456-426614174000",
  "message": "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç ID –≤ —Ö–µ–¥–µ—Ä–µ X-Session-Id –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤"
}
```

### 3. `/monitor` ‚Äî –ø—Ä—è–º–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å —Å–∞–π—Ç–∞

**POST**
```bash
curl -X POST http://localhost:8000/monitor \
  -H "Content-Type: application/json" \
  -H "X-Session-Id: your-session-id" \
  -d '{
    "url": "https://www.rentalads.com/apartments-for-rent/ny/new-york/",
    "max_items": 50
  }'
```

---

## üéØ –†–∞–±–æ—Ç–∞ —Å —Å–µ—Å—Å–∏—è–º–∏

### –ü—Ä–∏–º–µ—Ä –ø–æ–ª–Ω–æ–≥–æ workflow —Å –æ–¥–Ω–æ–π —Å–µ—Å—Å–∏–µ–π:
```python
import requests
import json

# 1. –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é
session_resp = requests.get("http://localhost:8000/session/new")
session_id = session_resp.json()["session_id"]
print(f"–°–µ—Å—Å–∏—è —Å–æ–∑–¥–∞–Ω–∞: {session_id}")

headers = {
    "Content-Type": "application/json",
    "X-Session-Id": session_id,
    "X-User-Id": "user123"
}

# 2. –ò–∑–≤–ª–µ–∫–∞–µ–º –æ–±—ä—è–≤–ª–µ–Ω–∏—è
resp1 = requests.post(
    "http://localhost:8000/ask",
    headers=headers,
    json={
        "question": "–ò–∑–≤–ª–µ–∫–∏ –∫–≤–∞—Ä—Ç–∏—Ä—ã —Å —Å–∞–π—Ç–∞",
        "urls": ["https://www.rentalads.com/apartments-for-rent/ny/new-york/"]
    }
)

# 3. –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ —Ü–µ–Ω–µ (–≤ —Ç–æ–π –∂–µ —Å–µ—Å—Å–∏–∏)
resp2 = requests.post(
    "http://localhost:8000/ask",
    headers=headers,
    json={
        "question": "–ü–æ–∫–∞–∂–∏ —Ç–æ–ª—å–∫–æ –∫–≤–∞—Ä—Ç–∏—Ä—ã –¥–µ—à–µ–≤–ª–µ 2000 –¥–æ–ª–ª–∞—Ä–æ–≤"
    }
)

# 4. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ —Ä—É–±–ª–∏ (–≤ —Ç–æ–π –∂–µ —Å–µ—Å—Å–∏–∏)
resp3 = requests.post(
    "http://localhost:8000/ask",
    headers=headers,
    json={
        "question": "–ü–µ—Ä–µ–≤–µ–¥–∏ —Ü–µ–Ω—ã –≤ —Ä—É–±–ª–∏"
    }
)

# 5. –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É (–≤ —Ç–æ–π –∂–µ —Å–µ—Å—Å–∏–∏)
resp4 = requests.post(
    "http://localhost:8000/ask",
    headers=headers,
    json={
        "question": "–ü–æ–∫–∞–∂–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —Ü–µ–Ω–∞–º"
    }
)

## üê≥ Docker Compose –≤–∞—Ä–∏–∞–Ω—Ç—ã

### Cloud Langfuse (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):
```
bash
docker compose up -d --build
```

---

## ‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

- –ê–≥–µ–Ω—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å –æ—Ç–∫—Ä—ã—Ç—ã–º–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏ (–±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
- HTML —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–∞–π—Ç–æ–≤ –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å—Å—è, —á—Ç–æ —Å–ª–æ–º–∞–µ—Ç –ø–∞—Ä—Å–∏–Ω–≥
- –î–ª—è —Ä–∞–±–æ—Ç—ã —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–µ–π—Å—Ç–≤—É—é—â–∏–π OPENAI_API_KEY
- Langfuse —Ç—Ä–µ–π—Å–∏–Ω–≥ –¥–æ–±–∞–≤–ª—è–µ—Ç –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É (~50-100ms)

## üìö –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [Langfuse Documentation](https://docs.langfuse.com)
- [LangChain Integration Guide](https://docs.langfuse.com/integrations/langchain)
- [OpenAI API Reference](https://platform.openai.com/docs)
- [FastAPI Documentation](https://fastapi.tiangolo.com)